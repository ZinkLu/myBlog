---
title: "【HomeServer】- 家庭硬件设备的演变"
date: "2022-09-25T00:25:00+08:00"
draft: false
summary: 【别硬折腾】系列之 【HomeServer. Part1.】
isMath: false
---

> 【别硬折腾】是我折腾硬件一些记录。
> 
> 这是我的第一期的内容，家庭服务器。
> 
> 本期分为三个篇章：
> 
> Part1 记录了家庭网络环境、设备的一些演变；
> 
> Part2 以我最新的方案为例，记录搭建的全过程；
> 
> Part3 是应用部分，我现在正在使用家庭服务器做的一些事情；
> 
> 本篇为Part1，记录了我从2018到2022年一些网络环境的变化，以及设备的变化，以及引入新设备后的一些方案的变化。最重要的，还有我自己的一些改变。

# 1. 为什么要写演变？

随着时间的推进，我们的认知在不停的变化，学习到的知识在不断积累。我们居住的环境也可能变化，刚毕业的时候我们还在合租，和大家公用WiFi，后面有可能自己租房子，自己去办理宽带，独立管理网络。我们也会不断新增硬件，不断替换掉旧的硬件。

我们不必上来就整一个机架回家，装上两个刀片服务器，整个什么全屋WIFI（可能连全屋都没有），也不需要整个16盘位NAS。

{{< img src=rack_server.webp size=50% lines=你真的需要他吗 >}}

比起高大全，根据当下的网络环境、资源和需求找到最合理的方案才是最值得考虑的。因此一开始，我本只想写一篇 《如何在 docker 中安装 OpenWrt 》的文章。结果过了一段时间，我发现我不需要再使用 Docker 作为旁路由，而文章也只是开了个头就仅仅开了个头。写演变的目的就是为了让本文更加具有参考性。好让处于不同阶段的读者都有所收获。

另外就是我也想记录自己这些折腾经历，基本上就是一个受锤的过程。提醒自己下次再要采购什么硬件的时候，记得三思。

# 2. 小米路由器，但是mini

<!-- 地点：人才公寓合租单间

网络环境：公用电信宽带200兆 -->

年轻的时候谁还没住过一个合租的屋子呢？

由于是和同事一起排队的人才公寓，网络自然一起去办理的，一起平分的押金，AA网费，200M 带宽公用。

大家一开始都是使用使用光猫的 WIFI 进行上网，其实也挺好。只有最远屋子的一个老哥由于 WIFI 信号太差，自己走墙内网线接了一个网件的 r7000 作为 AP，基本上就是最简单最纯真的美好。

<!-- 由于上海恶心的SDN网管，没有任何办法改桥接（SDN网关后面还有一个坑），所以大家都是直接使用 SDN 网关直连进行上网的， -->

{{< img src=网络拓扑图-合租房1.png size=50% lines=简简单单 >}}

但是总有人不老实，喜欢折腾。

之前父母家中长期使用的小米路由器 mini ，在长期运行后总是会断网，必须手动去重启。我爸没少因为这个路由器输掉网上的掼蛋对局，不断地重启操作也真的让人恼火。

不过也是，毕竟也是 2014 年的产品了，几个网线接口还都是百兆的，而且还是小米的产品，能用几年也是很了不起了。于是一怒之下，我直接买了当时网件的新品 r7000p。

不过话说回来，网件的东西还是挺经用的，即使这路由器已经从最开始的 999 跌倒了 400 块钱不到，但现在还好好地活着，特别的稳定，没出过大问题。

那个时候流行给路由器刷固件，实现一些高级的功能，总在网上看帖子说 r7000 可以华硕的梅林固件，我本来还想好好折腾一下这个 r7000p 的，但没想到和 r7000，一字之差，居然完全不支持刷机。可能是产品太新的原因，当时确实没有任何的途径可以进行刷机。后续的好长一段时间，我一直关注 r7000p 刷机进展，但也无疾而终。

r7000p 能不能刷不重要，重要的是我爸的牌局终于可以不用因为网络问题而输掉了。更何况，我还有退休下来的小米 mini ，也能让我折腾一段时间了。

在这里不得不说，小米确实是很有发烧精神的公司，至少那个时候的小米有。

彼时小米在官网上提供了数款路由器开启 ssh 的方法，也之前提供了默认的 root 密码，恰好小米路由器 mini 也在列，这简直就是广大用户的福音。现在的路由器好像都已经完全不支持 ssh 了，至少官方不会支持。这也是这台小米路由器 mini 我还一直收着的原因。

{{< img src=xiaomiwifimini.jpg size=50% lines=小米路由器mini >}}

有了 root + ssh ，路由器你要干什么可由不得你了。

于是在一个不老实人的努力下，我们的网络变成了这样：

{{< img src=网络拓扑图-合租房2.png size=50% lines=变得不单纯 >}}

将小米路由器 mini 作为网关，开启 NAT 后，我的子网就有了生命和活力。

虽然小米路由器 mini 全部都是百兆的口，但是我们本来就是公用的 200M 带宽，也算是自觉的一种体现了。

# 3. MacBook 大英雄

后来，告别了人才公寓，我搬到一居室和家人一起住。

网络也随着公用的 200M 带宽变成了独享的 200M，小米路由器再也没办法发光发热了。

在初期的一段时间，我们都是直接使用电信的光猫的 WIFI 直接上网的。其实也没什么不好的，但是由于需要一些高级功能，还是准备把自己的“智能”网关请回来。

正巧这段时间我一直在看树莓派，准备入手一个玩玩。由于树莓派只有一个网口，因此希望使用旁路由的形式去搭建这个网关。

{{< img src=网络拓扑图-旁路由.png size=50% lines=旁路由模式 >}}

> 旁路由（旁网关）模式：
> 
> 在子网中，需要上网的设备将网关设置为子网内的其他设备（非出口网关）。
> 
> 流量经过旁网关处理后再由旁网关转发到主网关，以实现特定功能。

这个方案麻烦的就是由于 dhcp 分配的网关默认是 192.168.1.1。如果需要走旁路由，则需要手动去设置 IP 地址，子网掩码和默认网关。

这个方案理论上没有任何问题，然而最终在我这里并没有实现，原因有二：

**第一个原因，光猫：**

先说下这个光猫了，也就是上海电信的 SDN 网关，简直就是一个坑货。

首先 SDN 网关的设置是没办法在后台去改变的。

> 网关后台管理密码为 `snd123456`，登录只能看信息。

这意味着无法*修改 dhcp 服务*和*路由器改桥接*。

无法修改配置都还是小问题。

最大的问题是： **SDN 的所有网络设备(包括无线网卡)都无法将互联网流量转发到旁路由上**。

{{< img src=网络拓扑图-旁路由2.png size=50% lines=此路不通 >}}

**第二个原因，我树莓派不想买了**

原因是树莓派的价格并不便宜。

尤其是 4b，那价格真的有点让人望而却步。

后来我无意间发现了 Intel 的 NUC，一个 i3 的 NUC也不贵。但是毕竟是 Intel，还是存在品牌溢价。再后来我又看到有国内其他厂商也在做准系统，于是又开始研究其他的小主机。

越研究小主机就越觉得树莓派性价比不高，最后放弃了购入树莓派的计划。

但我的折腾也没有停止。

在一次整理东西时，偶然间翻到了之前在海鲜市场购入的 ThunderBolt2 的网卡，这瞬间打开了我的思维。

**我沉睡着的 2015 年的 MacBook Pro 好像可以派上用场了。**

再确定过这张网卡是千兆，并不会成为网络贷款瓶颈后，我开始着手将 MacBook 改造为旁路由。

{{< img src=ThunderBolt_adapter.jpg size=30% lines=雷电2网卡 >}}

其实我是组好后才发现 SDN 网关无法转发流量的。我一度怀疑是我哪里配置的问题，或者是这方案根本行不通，又或者是雷电2网卡是不是坏了。

好在我最终怀疑到了 SDN 网关的头上，虽然没有十足的把握，但是我还是买了一台小米路由器 AX1800，准备用小米路由器来完成转发。当然，一次 NAT 在所难免。

MacBook 安装 OpenWrt 的方案也简单，在虚拟机软件（如 virtualbox ）中直接安装就行。需要配置下虚拟机的网络，要使用桥接模式，桥接到雷电2网卡上，后续手动设置下网络就行了。

对了，还要关闭 MacBook 的合盖休眠。

最终网络示意图如下：

{{< img src=网络拓扑图-旁路由3.png size=50% lines=高价软路由 >}}

这套方案一直持续到了我的 MacBook 电池鼓包。

> 电池鼓包的原因可能是长时间的运行、积热以及电池的老化。
>
> 后续我给电脑换了电池。仔细想想，MacBook 做软路由确实有点浪费。
> 
> 正好后面狐狸小姐的 MacBook 的也坏了，于是这台作为备用机至今还在服役。

# 4. 着迷准系统

之前说到没有买树莓派的原因就是觉得买这东西不如加点钱搞一个准系统。

不过都上了准系统，那性能不能太凑活，不上个 i7 R9 都对不起 X86 平台。

既然都 i7 了，那不如直接把内存搞大一点，还能当一个开发机。

硬盘肯定也不能落下，要又快又大。

这一轮思想斗争下来，直接把买三轮车的预算提到了买小汽车的预算。

需求是也从一个软路由变成了一台开发机：

1. CPU 性能不能太凑活，iGPU 也不能太捞；
2. 能耗比一定要高，风扇不能一直吵吵，也要省点电；
3. 双网口，不再让小米路由器做 NAT，减少性能损耗；
4. 内存支持尽可能大的拓展；
5. 做工扎实，电源OK，要 7*24 小时运行；

需求明确，经过一轮搜索，我果断相中 Intel 的 NUC。买一个 8 代或者 9 代的 i7 版本，插上个 64G 的内存，配一块 SSD 。

不过缺点就是 NUC 太贵了，i7 得裸机就要 4000 多了，能耗比也很一般，网卡也就一个。性价比太低。

不过不得不说 NUC 确实是一个不错的产品形态。其本质是一个没有屏幕的笔记本，放在办公室、家里当做一个开发、办公、上网的设备，外接一两个更大的显示器，不占地方又安静，真是不错。

而且 NUC 出来的很早，销量也一直不错（不然就不会出新款了）。但彼时正好是 AMD zen2、zen3 发力的时期，Intel CPU 能耗比劣势太大。于是在能耗比上，只能考虑 AMD 的 CPU。

即便 AMD 没有推出过官方的准系统，这个市场也已经被 Intel 教育过。随着市场的成熟，越来越多的硬件产商涌入，AMD 的准系统也被安排的明明白白。

没有官方的支持其实还是有一定的坏处的。那就是由于库存的原因，搭载新产品的准系统总没有办法第一时间投放到市场去。

确定了要加入红色大军，那就开始对比各家准系统。其实到最后选择也并不多。无非是纠结是便宜一点的 4900 还是性能强一点的 5900。

然后就是等待一个时机，等到价格合适。直接下手。

于是我最后以 4400 多得到了一个 AMD 的准系统，它的配置如下：

1. AMD 4900H
2. 镁光 32G * 2 3200MHZ
3. 西数m.2 500G
4. Realtek 千兆网卡 * 2
5. Intel AX210 WIFI6 + 蓝牙5
6. 佳航电源

有了这么强大的一颗心脏，小米路由器 AX1800 再也不用负责做网关和 NAT 了，化作无线 AP 即可。

为了让 AX1800 这个 AP 更加的纯粹，我还必须撤销它交换机的职位。于是我干脆又购入了一台 NETGEAR 的 8 口千兆交换机。

至此，家里的网络设备和环境已经发生了天翻地覆的变化：

{{< img src=网络拓扑图-AMD1.png size=50% lines=小主机网关 >}}

小主机我安装了 Ubuntu 18.04。这次，我尝试在 docker 中搭建了 OpenWrt。

搭建过程会比使用虚拟机来的麻烦一点，因为需要到 macvlan 。

而使用到 macvlan 就意味着你的虚拟网卡和你真实的网卡是没办法通讯的，所以为了能让小主机本身能连上网，确实是花了一些力气。

由于交换机的存在，之前接在小米路由器上的电脑和 PS4 全部都直接接入了 NETGEAR 的交换机。

小主机的功能肯定不止软路由。应用的部分我们放到 Part3 中再分享。

# 5. 低功耗小主机

这个方案实在是太好了，几乎不需要再换了。

但前面也说了，这台小主机也承担了我作为开发（折腾）机的重任。

在我不停折腾的压力下，再加上可能基于 docker 与 macvlan 的方案，或者又可能是螃蟹网卡的原因，这台小主机的网络并没有想的这么稳定。网络经常出现中断的情况，一般情况下要过个二三十秒才会恢复。

而且这也大大降低了这台小主机的便携性。虽然有 frp 做内网穿透，但是我还是期望出差可以带着他出去，不过于他在家庭网络中的重要地位，我又不得不放弃这个念头。

于是我又看起了低功耗的小主机。虽然都是小主机，但是低功耗小主机正如其名，他的功耗真的很低。相对于 4900H 35-54W 的热功耗设计，低功耗小主机的 TDP 可以低于 10 W。在其待机状态下，一般都可以控制在 5W 左右，在多数情况下使用被动散热就可以了。正因为此，低功耗小主机一般被用于工业控制机或者硬路由，在静音的同时，也能做到 7 * 24 小时运作。

这么看来，低功耗小主机更像树莓派。但是树莓派的网络接口实在太少，且价格真的太贵。还有不得不提的，我还有两条拆机的 DDR4 16G 的内存。

于是我最终选择了基于 Intel N5105 的工业小主机，在低功耗的同时，还配备了 4 个 2.5G 的 Intel i226v 网卡。插上 16G 拆机内存，再整一个 500G 的 SSD，又是一条好汉。

不得不提，N5105 、J4125 这种低功耗 U 也被各大 NAS 厂商使用在他们的产品中。不过 NAS 设备是真的贵，某辉和某通不含硬盘的裸机价格都要 2K 起步了。而我这个机器全部整下来，一共才 1K 左右。

毕竟这些 NAS 厂商卖的是软件，是服务。咱们靠的是折腾，凭实力省的钱，那我自己组一个 raid 然后接在小主机上通过 SMB 进行网络共享也很合理吧。铁威马的 DAS + 希捷 Exos 8T * 2  + 软 raid0 安排。

这一套存储设备虽然不是价格最高的硬件（2600左右），但数据无价。为了保护硬盘的相对安全，我还配了一个 UPS 电源作为整个系统的电源平台。

增加了这么些硬件后，我的拓扑图变成：

{{< img src=网络拓扑图-Intel.png size=50% lines=画的比较乱 >}}

如图所示，OpenWrt 被搭建在了 KVM 虚拟机中，而搭建的过程绝对堪称地狱难度的，我在 part2 再做分享。

对了，你可以已经注意到光猫已经被我改成了桥接模式，至于有啥好处，目前好像也没啥太大好处，反正也没有公网 ipv4。

这就是目前的家庭硬件的组建方案了。那本文就到此结束，欢迎各位多提意见。如果后续网络、设备还有什么变化，都会及时更新。
